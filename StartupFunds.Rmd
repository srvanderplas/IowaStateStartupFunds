---
title: "Startup Funds Investigation"
author: "Susan VanderPlas"
date: "June 10, 2015"
output: 
  knitrBootstrap:::bootstrap_document:
    theme: cerulean
    highlight: idea
    menu: FALSE
    clean_supporting: TRUE
---


```{r setup, echo=FALSE}
library(knitr)
library(htmltools)
library(ggplot2)
library(scales)
# s0 <- knitr::knit_hooks$get('source')
# knitr::knit_hooks$set(
#   list(
#     source=function(x,options){
#       if(is.null(options$class)) s0(x, options)
#       else
#         tags$button(class=c())
#     }
#   )
# )
# 
knitr::opts_chunk$set(bootstrap.show.code=FALSE, bootstrap.show.output=FALSE, bootstrap.show.message=FALSE, warning=F, message=F, out.width="100%", cache=T, echo=F)
knitr::opts_knit$set(root.dir="../../IowaStateStartupFunds/")
```

# Introduction

The following information was taken from meeting notes (meetings on 6/4/2015 and 5/20/2015)

## Goals for the project:

1. Examine trends (or lack thereof) in startup funding over time
2. Examine return on investment for startup funding 
    - Publications
    - Proposals submitted
    - Grants received
    - Tenure

## Data: 

1. Spreadsheets from the Office of the Vice President for Research
    - Name, Department, College, Salary, Start Date
    - Startup package allocation (by category) 
    - Source of startup funding
2. Database from Office of Sponsored Programs Administration (2 databases, 2005-2010 and 2010-2015. Early database will be messier)
    - Grants received (by month, as well as total award $$)
    - Proposals submitted
3. Additional information 
    - Publications (from scraping Google Scholar)
    - Where individuals came from (public/private institution, small/large)

## Other factors:

- 2003-2008 was a competitive hiring season (may have larger startup packages as a result)
- 2008 Crash and budget freeze at the state level
- American Recovery and Reinvestment Act (2009) with increased funding levels
- 2012 slowdown in research funding (may need to compare to NSF/NIH/USDA/DOD/DOE/Ames Lab funding levels)


# Analysis

## Office of the Vice President for Research Data

```{r OVPRdata, cache=F}
source("Code/CleanStartupFundingData.R")
```

### Total Startup Package Cost
```{r TotalCost, echo=F, fig.width=9, fig.height=5, fig.cap="Total Startup Package Cost, by College"}
qplot(Year, Total.Cost, color=Dept1, data=hires, geom="jitter", shape=I(1)) +
scale_y_log10() +
scale_color_discrete(guide="none") +
ggtitle("Total Startup Package Cost")  +
theme_bw() +
facet_wrap(~College, ncol=4)
```

### Computing Expenses
```{r ComputingExpenseProp, echo=F, fig.width=8, fig.height=5, fig.cap=c("Proportion of startup $ allocated for computers", "Amount allocated for computers")}
qplot(Year, Amount/Total.Cost, color=Dept1, data=subset(startup.package, Item=="Computer.peripherals"), geom="jitter", shape=I(1)) +
scale_color_discrete(guide="none") +
ggtitle("Proportion of package allocated to computer equip.")  +
theme_bw() +
facet_wrap(~College, ncol=4)

qplot(Year, Amount, color=Dept1, data=subset(startup.package, Item=="Computer.peripherals"), geom="jitter", shape=I(1)) +
scale_color_discrete(guide="none") +
ggtitle("Amount of startup funds allocated for computer equip.")  +
  scale_y_sqrt(breaks=c(0, 1000, 5000, 10000, 100000), label=c("0", "$1000", "$2500", "$10K", "$100K")) +
ylab("Amount") + 
theme_bw() +
facet_wrap(~College, ncol=4, scales="free_y")
```

In Ag & Life Science, I suspect the computer allocation has decreased due to Moore's law (it's cheaper to get computers that can process genetic data now than it was in 2005). Engineering allocations seem to be somewhat department-related (clustering of green and blue values, in particular). The business school seems remarkably standardized - the amount decreased in 2011-2013, but otherwise has been at approximately the same level (with extremely low variance). 

### Lab Space/Equipment Expenses
```{r LabExpenseProp, echo=F, fig.width=8, fig.height=5, fig.cap=c("Proportion of startup $ allocated for lab space and equipment.", "Amount allocated for lab space and equpment")}
qplot(Year, Amount/Total.Cost, color=Dept1, data=subset(startup.package, Item=="Lab.space.equipment"), geom="jitter", shape=I(1)) +
scale_color_discrete(guide="none") +
ggtitle("Proportion of package allocated to lab space/equip.")  +
theme_bw() +
facet_wrap(~College, ncol=4)

qplot(Year, Amount, color=Dept1, data=subset(startup.package, Item=="Lab.space.equipment"), geom="jitter", shape=I(1)) +
scale_color_discrete(guide="none") +
ggtitle("Amount of startup funds allocated for lab space/equip.")  +
theme_bw() +
facet_wrap(~College, ncol=4, scales="free_y")
```

Lab space and lab equipment are obviously only relevant for some colleges. The proportion and raw amount of funding for lab space and equipment in LAS has decreased, while the amount of funding in engineering and human sciences has increased (though the proportion of the funding package has stayed reasonably consistent).  

### Graduate Assistant Expenses
```{r GradExpenseProp, echo=F, fig.width=8, fig.height=5, fig.cap=c("Proportion of startup $ allocated for graduate assistant support.", "Amount allocated for graduate assistant support")}
qplot(Year, Amount/Total.Cost, color=Dept1, data=subset(startup.package, Item=="Graduate.assistants"), geom="jitter", shape=I(1)) +
scale_color_discrete(guide="none") +
  geom_smooth(aes(x=Year, y=Amount/Total.Cost), color=I("black"), data=subset(startup.package, Item=="Graduate.assistants")) + 
ggtitle("Proportion of package allocated for graduate assistants")  +
theme_bw() +
facet_wrap(~College, ncol=4)

qplot(Year, Amount, color=Dept1, data=subset(startup.package, Item=="Graduate.assistants"), geom="jitter", shape=I(1)) +
  geom_smooth(aes(x=Year, y=Amount), color=I("black"), data=subset(startup.package, Item=="Graduate.assistants")) + 
scale_color_discrete(guide="none") +
ggtitle("Amount of startup funds allocated for graduate assistants")  +
theme_bw() +
facet_wrap(~College, ncol=4, scales="free_y")
```

The recession seems to have hit graduate student support fairly hard (relative to other expenses). Looking at the gross amount of funding allocated for graduate students, we see that startup packages in engineering and human sciences include more support for graduate students than in the past (this is particularly dramatic in human sciences, though the amount of funding is still overall lower than in engineering). In the other colleges, the amount of support for graduate students has stayed relatively consistent over the past 10 years. 

### Summer Support
```{r SummerExpenseProp, echo=F, fig.width=8, fig.height=5, fig.cap="Proportion of startup $ allocated for summer support."}
qplot(Year, Amount/Total.Cost, color=Dept1, data=subset(startup.package, Item=="Summer.support"), geom="jitter", shape=I(1)) +
  geom_smooth(aes(x=Year, y=Amount/Total.Cost), color=I("black"), data=subset(startup.package, Item=="Summer.support")) + 
scale_color_discrete(guide="none") +
ggtitle("Proportion of package allocated for summer support")  +
theme_bw() +
facet_wrap(~College, ncol=4)

qplot(Year, Amount, color=Dept1, data=subset(startup.package, Item=="Summer.support"), geom="jitter", shape=I(1)) +
  geom_smooth(aes(x=Year, y=Amount), color=I("black"), data=subset(startup.package, Item=="Summer.support")) + 
scale_color_discrete(guide="none") +
ggtitle("Amount of startup funds allocated for summer support")  +
theme_bw() +
facet_wrap(~College, ncol=4, scales="free_y")
```

Summer funding seems to be fairly common in some areas (business, some of LAS) and almost unheard of in others (design, vet med). 

### Research Support
```{r ResearchExpenseProp, echo=F, fig.width=8, fig.height=5, fig.cap=c("Proportion of startup $ allocated for research support.", "Amount of startup $ allocated for research support.")}
qplot(Year, Amount/Total.Cost, color=Dept1, data=subset(startup.package, Item=="Research.support"), geom="jitter", shape=I(1)) +
scale_color_discrete(guide="none") +
ggtitle("Proportion of package allocated for research support")  +
theme_bw() +
facet_wrap(~College, ncol=4)

qplot(Year, Amount, color=Dept1, data=subset(startup.package, Item=="Research.support"), geom="jitter", shape=I(1)) +
scale_color_discrete(guide="none") +
ggtitle("Amount of funding allocated for research support")  +
theme_bw() +
facet_wrap(~College, ncol=4, scales="free_y")
```

### Moving Expenses
```{r MovingExpenseProp, echo=F, fig.width=8, fig.height=5, fig.cap=c("Proportion of startup $ allocated for moving expenses.", "Amount allocated to moving expenses")}
qplot(Year, Amount/Total.Cost, color=Dept1, data=subset(startup.package, Item=="Moving.expenses"), geom="jitter", shape=I(1)) +
scale_color_discrete(guide="none") +
ggtitle("Proportion of package allocated for moving expenses")  +
theme_bw() +
facet_wrap(~College, ncol=4)

qplot(Year, Amount, color=Dept1, data=subset(startup.package, Item=="Moving.expenses"), geom="jitter", shape=I(1)) +
scale_color_discrete(guide="none") +
ggtitle("Amount allocated for moving expenses")  +
theme_bw() +
facet_wrap(~College, ncol=4)
```

Moving expenses amounts seem to be reasonably consistent across colleges. The business college seems to once again have a standard package that may change year to year with occasional negotiation. The same may be true of the vet med college. 

## Office of Sponsored Programs Administration Data

Datasets from OSPA contain information on proposals and awards from 2005-2010 and 2010-2015 (4 total databases). 


```{r OSPAdata, cache=F}
source("Code/CleanAwardsData.R")
source("Code/CleanProposalsData.R")
```

### Proposals

```{r ProposalExploration}

prop$Source2 <- factor(prop$Source, labels=c("FY06-FY10", "FY11-FY16"), levels=c("Proposals FY06 to FY10.csv", "KC Investigator Proposal ALL 06072015.csv"))

qplot(Activity.Type, data=prop, color=I("black"), fill=I("grey")) + facet_grid(Source2~.) + theme_bw()  + theme(legend.position="bottom", axis.text.x=element_text(angle=45, hjust=1)) + ggtitle("Proposal Activities")

qplot(Proposal.Type, data=prop, color=I("black"), fill=I("grey")) + facet_grid(Source2~.) + theme_bw()  + theme(legend.position="bottom", axis.text.x=element_text(angle=45, hjust=1)) + ggtitle("Proposal Type")

qplot(Grant.Type, data=prop, color=I("black"), fill=I("grey")) + facet_grid(Source2~.) + theme_bw()  + theme(legend.position="bottom", axis.text.x=element_text(angle=45, hjust=1)) + ggtitle("Funding Type")

qplot(Proposal.Status, fill=Source, position="stack", data=prop) + theme_bw() + 
  theme(legend.position="bottom")  +
  ggtitle("Proposal Status")

prop.unique <- prop %>% group_by(Proposal.Number, Submit.Date, Source2) %>% summarise(ct=length(Proposal.Number))

qplot(floor_date(Submit.Date, "month"), color=I("black"), fill=Source2, position="stack", data=prop.unique) + theme_bw() + theme(legend.position="bottom") + xlab("Submission Date") + ylab("Count") + ggtitle("Number of Proposals Submitted")

rm(prop.unique)

prop.span <- melt(prop, id.vars = c("Proposal.Number", "Source2", "Proposal.Title"), measure.vars=c("Start.Date", "End.Date", "Submit.Date"), value.name = "Date", variable.name = "Proposal.Span")
prop.span$Proposal.Span <- factor(prop.span$Proposal.Span, levels=c("Submit.Date", "Start.Date", "End.Date"))

ggplot(data=prop.span) + 
  geom_histogram(aes(x=floor_date(Date, "quarter"), fill=Source2), 
               position="stack", adjust=1.25, trim=T, binwidth=15*60*24*365) + 
  facet_grid(Proposal.Span~.) + 
  theme_bw() + 
  scale_x_datetime(limits=c(mdy("07012001"), mdy("07012026")), breaks=date_breaks("5 years")) + 
  scale_fill_discrete("Data Source") + xlab("Date") + ylab("Density") + ggtitle("Proposal Timeline") + 
  theme(legend.position="bottom") 

prop.span <- melt(prop, id.vars = c("Proposal.Number", "Source2", "Proposal.Title", "Submit.Date"), measure.vars=c("Start.Date", "End.Date"), value.name = "Date", variable.name = "Proposal.Span")
prop.span$Proposal.Span <- factor(prop.span$Proposal.Span, levels=c("Start.Date", "End.Date"))
prop.span$FundingLag <- with(prop.span, difftime(Date, Submit.Date, units="days")) 
prop.span$FundingLag <- as.numeric(prop.span$FundingLag)/(365.25) # convert to years

ggplot(data=prop.span) + 
  geom_histogram(aes(x=FundingLag), fill="grey", color="black", binwidth=.125, inherit.aes=F) + 
  facet_wrap(~Proposal.Span, scales="free_x") + 
  theme_bw() + 
  scale_x_continuous(limits=c(-1, 10), breaks=0:9) + 
  xlab("Years from Proposal Submission Date") + ylab("Count") + ggtitle("Proposal Timeline") + 
  theme(legend.position="bottom") 

rm(prop.span)

ggplot(data=prop) + 
  geom_histogram(aes(x=as.numeric(difftime(End.Date, Start.Date, units="days")/365.25)), 
                 binwidth=.25, color="black", fill="grey") + 
  scale_x_continuous("Proposal Duration", limits=c(0, 10), breaks=0:10) + 
  ylab("Count") + ggtitle("Duration of Proposed Funding") + theme_bw() + 
  theme(legend.position="bottom") 

```

### Awards

```{r AwardExploration}

awards$Source2 <- factor(awards$Source, labels=c("FY06-FY10", "FY11-FY16"), levels=c("Awards FY06 to FY10.csv", "KC Investigator Award ALL 06072015.csv"))

qplot(Activity.Type, data=awards, color=I("black"), fill=I("grey")) + facet_grid(Source2~.) + theme_bw()  + theme(legend.position="bottom", axis.text.x=element_text(angle=45, hjust=1)) + ggtitle("Funding Activity Types")

qplot(Award.Type, data=awards, color=I("black"), fill=I("grey")) + facet_grid(Source2~.) + theme_bw()  + theme(legend.position="bottom", axis.text.x=element_text(angle=45, hjust=1)) + ggtitle("Funding Award Type")

award.span <- melt(awards, id.vars = c("Award.Number", "Source2", "Award.Title"), measure.vars=c("Start.Date", "End.Date"), value.name = "Date", variable.name = "Award.Span")
award.span$Award.Span <- factor(award.span$Award.Span, levels=c("Start.Date", "End.Date"))

ggplot(data=award.span) + 
  geom_histogram(aes(x=floor_date(Date, "quarter"), fill=Source2), 
               position="stack", adjust=1.25, trim=T, binwidth=15*60*24*365) + 
  facet_grid(Award.Span~.) + 
  theme_bw() + 
  scale_x_datetime(limits=c(mdy("07012001"), mdy("07012026")), breaks=date_breaks("5 years")) + 
  scale_fill_discrete("Data Source") + xlab("Date") + ylab("Count") + ggtitle("Award Timeline")

rm(award.span)

ggplot(data=awards) + 
  geom_histogram(aes(x=as.numeric(difftime(End.Date, Start.Date, units="days"))/365.25), 
                 color="black", fill="grey", binwidth=.25) + 
  theme_bw() + 
  scale_x_continuous("Years of Funding", limits=c(-1, 10), breaks=0:9) + 
  scale_fill_discrete("Data Source") + xlab("Date") + ylab("Count") + ggtitle("Funding Span") + theme(legend.position="bottom")

qplot(Award.Status, data=awards, color=I("black"), fill=I("grey")) + facet_wrap(~Source2) + theme_bw() + theme(legend.position="bottom", axis.text.x=element_text(angle=45, hjust=1)) + ggtitle("Award Status")

awards$novalue <- c("No Monetary Value", "Monetary Value")[1+as.numeric(awards$Award.Amount>0)]
qplot(Award.Status, fill=novalue, position="stack", data=awards, facets=~Source2) + theme_bw() + theme(legend.position="bottom", axis.text.x=element_text(angle=45, hjust=1)) + ggtitle("Award Status by Grant Amount")


ggplot(data=awards) + 
  geom_histogram(aes(x=Start.Date, weight=Award.Amount), 
                 color="black", fill="grey") + 
  theme_bw() + 
  scale_fill_discrete("Data Source") + xlab("Date") + ylab("Count") + ggtitle("Funding Span") + theme(legend.position="bottom")
```




# Merged Data

```{r MergeDatasets, fig.width=8, fig.height=6}
received.money <- awards %>% group_by(Investigator) %>% summarize(grant.received = sum(Award.Amount), n.awards = length(unique(Award.Number)))

submitted.proposals <- prop %>% group_by(Investigator) %>% summarize(total.proposal.money = sum(Proposal.Amount), n.proposals = length(unique(Proposal.Number)), prop.fund.pct = mean(Proposal.Status=="Funded"))

tmp <- merge(hires, received.money, by.x="Name", by.y="Investigator", all.x=T)
tmp <- merge(tmp, submitted.proposals, by.x="Name", by.y="Investigator", all.x=T)

tmp$grant.received[is.na(tmp$grant.received)] <- 0
tmp$n.awards[is.na(tmp$n.awards)] <- 0
tmp$total.proposal.money[is.na(tmp$total.proposal.money)] <- 0
tmp$n.proposals[is.na(tmp$n.proposals)] <- 0
tmp$prop.fund.pct[is.na(tmp$prop.fund.pct)] <- 0

# head(tmp)

qplot(Year, grant.received, data=tmp, geom="jitter", color=College, shape=College, size=I(4)) + 
  scale_shape_manual(values=c('A', 'B', 'D', 'E', 'H', 'L', 'V')) + 
  guides(shape=guide_legend(ncol=4), color=guide_legend(ncol=4)) + 
  xlab("Year Hired") + ylab("Total Grant $ Received") + ggtitle("Grant Receipts by Year of Hire") + 
  theme_bw() +  theme(legend.position="bottom")


qplot(Total.Cost, grant.received, data=tmp, geom="point", color=College, shape=College, size=I(4)) + 
  geom_smooth(method="loess", inherit.aes=F, aes(x=Total.Cost, y=grant.received)) + 
  scale_shape_manual(values=c('A', 'B', 'D', 'E', 'H', 'L', 'V')) + 
  guides(shape=guide_legend(ncol=4), color=guide_legend(ncol=4)) + 
  scale_x_continuous(breaks=c(0, 30000, 100000, 300000, 2000000), 
                     labels=c("$0", "$30K", "$100K", "$300K", "$2M"), 
                     trans="sqrt", limits=c(0, 2000000)) + 
  scale_y_continuous(breaks=c(0, 50000, 100000, 300000, 1000000, 10000000, 50000000), 
                     labels=c("$0", "$50K", "$100K", "$300K", "$1M", "$10M", "$50M"), 
                     trans="sqrt", limits=c(0, 50000000)) + 
  xlab("Startup Package Cost") + ylab("Total Grant $ Received") + 
  ggtitle("Startup Package Cost/Benefit in Grant Receipts") +
  theme_bw() + theme(legend.position="bottom", legend.direction="vertical")


qplot(Total.Cost, total.proposal.money, data=tmp, geom="point", color=College, shape=College, size=I(4)) + 
  geom_smooth(method="loess", inherit.aes=F, aes(x=Total.Cost, y=total.proposal.money)) + 
  scale_shape_manual(values=c('A', 'B', 'D', 'E', 'H', 'L', 'V')) + 
  guides(shape=guide_legend(ncol=4), color=guide_legend(ncol=4)) + 
  scale_x_continuous(breaks=c(0, 30000, 100000, 300000, 2000000), 
                     labels=c("$0", "$30K", "$100K", "$300K", "$2M"), 
                     trans="sqrt", limits=c(0, 2000000)) + 
  scale_y_continuous(breaks=c(0, 10000, 100000, 300000, 1000000, 10000000, 100000000, 300000000), 
                     labels=c("$0", "$50K", "$100K", "$300K", "$1M", "$10M", "$100M", "$300M"), 
                     trans="sqrt", limits=c(0, 300000000)) + 
  xlab("Startup Package Cost") + ylab("Total $ in Grants Proposed") + 
  ggtitle("Startup Package Cost/Benefit in Proposals") +
  theme_bw() + theme(legend.position="bottom", legend.direction="vertical")
```